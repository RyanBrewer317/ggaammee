<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ggaammee</title>
</head>
<body>
<table>
    <tr>
        <td style="vertical-align: top;">
            <canvas id="screen" style="display: inline; margin-right: 0; padding-right: 0;"></canvas>
        </td>
        <td style="vertical-align: top;">
            <canvas id="hotbar" style="margin-left: 0; padding-left: 0; display: inline;"></canvas>
        </td>
    </tr>
</table>

<script>
    const HOST = location.origin.replace(/^http/, 'ws');
    const Carryable = ['Copper','Tin','Stone','CherryLog','StoneTool','BronzeCherryAxe','BronzeCherryPickAxe','BuzzBronzeCherryAxe','BuzzBronzeCherryPickAxe','DarkBronzeCherryAxe','DarkBronzeCherryPickAxe','Moss','FlytrapSeed','Cherry','CypressLog','CypressCone','RedwoodCone','RedwoodLog','Bronze','BuzzBronze','DarkBronze','Slime','Glass','SlimeGlass','Clay','BronzeCypressAxe','BronzeCypressPickAxe','BuzzBronzeCypressAxe','BuzzBronzeCypressPickaxe','DarkBronzeCypressAxe','DarkBronzeCypressPickAxe','BronzeRedwoodAxe','BronzeRedwoodPickAxe','BuzzBronzeRedwoodAxe','BuzzBronzeRedwoodPickAxe','DarkBronzeRedwoodAxe','DarkBronzeRedwoodPickaxe','BronzeArmor','BuzzBronzeArmor','DarkBronzeArmor','Necrum','Zipium','SlimyBronzeCherryAxe','SlimyBuzzBronzeCherryAxe','SlimyDarkBronzeCherryAxe','SlimyBronzeCypressAxe','SlimyBuzzBronzeCypressAxe','SlimyDarkBronzeCypressAxe','SlimyBronzeRedwoodAxe','SlimyBuzzBronzeRedwoodAxe','SlimyDarkBronzeRedwoodAxe','SlimyBronzeArmor','SlimyBuzzBronzeArmor','SlimyDarkBronzeArmor','GlassedBronzeArmor','GlassedBuzzBronzeArmor','GlassedDarkBronzeArmor','SlimeGlassBronzeArmor','SlimeGlassBuzzBronzeArmor','SlimeGlassDarkBronzeArmor','SiliconBronzeArmor','SiliconBuzzBronzeArmor','SiliconDarkBronzeArmor','ReinforcedBronzeArmor','ReinforcedBuzzBronzeArmor','ReinforcedDarkBronzeArmor','Sand','CherryWood','Redwood','Cypress'];
    let hotbar = ['', '', '', '', '', '', '', '', '', ''];
    let $screen = document.getElementById('screen');
    let $hotbar = document.getElementById('hotbar');
    $screen.width = Math.floor(innerWidth-100);
    $screen.height = Math.floor(innerHeight-100);
    $hotbar.height = 355;
    $hotbar.width = 40;
    let REGION_HEIGHT = 64;
    let REGION_WIDTH = 127;
    let WUNIT = Math.round($screen.width/REGION_WIDTH)*3;
    let HUNIT = Math.round($screen.height/REGION_HEIGHT)*3;
    let ctx = $screen.getContext('2d');
    let ctx2 = $hotbar.getContext('2d');
    let joinedmessage = true;
    let name = '';
    let players = {};

    let smallrocksheet = new Image();
    smallrocksheet.src = 'img/smallrocksheet.png';
    let bigrocksheet = new Image();
    bigrocksheet.src = 'img/bigrocksheet.png';
    let smallrockcoppersheet = new Image();
    smallrockcoppersheet.src = 'img/smallrockcoppersheet.png';
    let bigrockcoppersheet = new Image();
    bigrockcoppersheet.src = 'img/bigrockcoppersheet.png';
    let smallrocktinsheet = new Image();
    smallrocktinsheet.src = 'img/smallrocktinsheet.png';
    let bigrocktinsheet = new Image();
    bigrocktinsheet.src = 'img/bigrocktinsheet.png';

    let drawfullmap = (map, selected) => {
      // console.log('drawing map');
      let textmap = map;
      let selected_block = selected;
      let hero = {};
      for (p in players) {
        if (p === name && players.hasOwnProperty(p)) {
          hero = players[p];
        }
      }
      let transposed = [];
      for (let y = 0; y < REGION_HEIGHT; y++) {
        transposed.push(textmap.split('<br>')[y].split(''));
      }
      let RegionalMap = transposed[0].map((_, colIndex) => transposed.map(row => row[colIndex]));
      // noinspection SillyAssignmentJS
      $screen.width = $screen.width;
      ctx.translate(Math.floor(-(hero.x-1)*WUNIT+(REGION_WIDTH*WUNIT/6)), Math.floor(-(REGION_HEIGHT-hero.y-1)*HUNIT+(REGION_HEIGHT*HUNIT/6)));
      for (let y = 0; y < REGION_HEIGHT; y++) {
        for (let x = 0; x < REGION_WIDTH; x++) {
          let block = RegionalMap[x][y];
          if (block === 'D') {
            ctx.fillStyle = '#593c06';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
          } else if (block === 'B') {
            ctx.fillStyle = '#000';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
          } else if (block === ' ') {
            ctx.fillStyle = '#dbffff';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
          } else if (['S', 'T', 'C'].includes(block)) {
            ctx.fillStyle = '#dbffff';
            // ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
            if (RegionalMap[x][y + 1] && ['S', 'T', 'C'].includes(RegionalMap[x][y + 1])) {
              // theres stone below
              if (RegionalMap[x][y - 1] && ['S', 'T', 'C'].includes(RegionalMap[x][y - 1])) {
                //theres stone above and below
                if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                  //theres stone to the left, above, and below
                  if (RegionalMap[x - 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x - 1][y])) {
                    //----theres stone on all sides
                    ctx.drawImage(bigrocksheet, 80, 160, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone to the left, above, and below, but not to the right
                    ctx.drawImage(bigrocksheet, 160, 160, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                } else {
                  //theres stone above and below but not to the left
                  if (RegionalMap[x - 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x - 1][y])) {
                    //----theres stone above and below and to the right, but not to the left
                    ctx.drawImage(bigrocksheet, 0, 160, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone above and below but not to either side
                    ctx.drawImage(bigrocksheet, 238, 0, 82, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                }
              } else {
                //theres stone below and not above
                if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                  //theres stone below and to the left but not above
                  if (RegionalMap[x - 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x - 1][y])) {
                    //----theres stone below, to the right, and to the left, but not above
                    ctx.drawImage(bigrocksheet, 80, 80, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone below and to the left but not to the right or above
                    ctx.drawImage(bigrocksheet, 160, 80, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                } else {
                  //theres stone below but not to the left or above
                  if (RegionalMap[x - 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x - 1][y])) {
                    //----theres stone below and to the right but not to the left or above
                    ctx.drawImage(bigrocksheet, 0, 80, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone below but not anywhere else
                    ctx.drawImage(smallrocksheet, 80, 160, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                }
              }
            } else {
              //theres no stone below
              if (RegionalMap[x][y - 1] && ['S', 'T', 'C'].includes(RegionalMap[x][y - 1])) {
                //theres stone above but not below
                if (RegionalMap[x - 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x - 1][y])) {
                  //theres stone above and to the left but not below
                  if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                    //----theres stone above and to either side but not below
                    ctx.drawImage(bigrocksheet, 80, 240, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone above and to the left but not the right or below
                    ctx.drawImage(bigrocksheet, 160, 240, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                } else {
                  //theres stone above but not to the left or below
                  if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                    //----theres stone above and to the right but not to the left or below
                    ctx.drawImage(bigrocksheet, 0, 240, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres stone above but not anywhere else
                  }
                }
              } else {
                //theres no stone above or below
                if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                  //theres stone to the left and not above or below
                  if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                    //----theres stone to either side but not below or above
                  } else {
                    //----theres stone to the left but not anywhere else
                    ctx.drawImage(smallrocksheet, 160, 240, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  }
                } else {
                  //theres no stone to the left, above, or below
                  if (RegionalMap[x + 1][y] && ['S', 'T', 'C'].includes(RegionalMap[x + 1][y])) {
                    //----theres stone to the right and nowhere else
                    ctx.drawImage(smallrocksheet, 0, 240, 80, 80, x*WUNIT, y*HUNIT, WUNIT, HUNIT);
                  } else {
                    //----theres no stone around
                  }
                }
              }
            }
          } else if (block === 'L') {
            ctx.fillStyle = '#009414';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
          } else if (block === 'H') {
            ctx.fillStyle = '#87331e';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);
          }



          if (block === 'D' && RegionalMap[x][y-1] && RegionalMap[x][y-1] === ' ') {
            ctx.fillStyle = '#208e24';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT/3);
          }
          if (block === 'H' && RegionalMap[x+1] && RegionalMap[x+1][y] === ' ') {
            ctx.fillStyle = '#dbffff';
            ctx.fillRect((x+0.75)*WUNIT, y*HUNIT, WUNIT/4, HUNIT);
          }
          if (block === 'H' && RegionalMap[x-1] && RegionalMap[x-1][y] === ' ') {
            ctx.fillStyle = '#dbffff';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT/4, HUNIT);
          }
          // if (block === 'T') ctx.fillStyle = '#dcdfd6';
          // if (block === 'C') ctx.fillStyle = '#dfba85';
          // if (block === 'T' || block === 'C') {
          //   ctx.fillRect((x+0.6)*WUNIT, (y+0.2)*HUNIT, WUNIT/6, HUNIT/6);
          //   ctx.fillRect((x+0.3)*WUNIT, (y+0.7)*HUNIT, WUNIT/8, HUNIT/8);
          // }
        }
      }
      if (RegionalMap[selected_block[0]-1] && RegionalMap[selected_block[0]-1][(REGION_HEIGHT - selected_block[1] - 1)] !== ' ') {
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 0.5;
        ctx.strokeRect((selected_block[0]-1) * WUNIT, (REGION_HEIGHT - selected_block[1] - 1) * HUNIT, WUNIT, HUNIT);
      }
      for (let i = 0; i < Object.values(players).length; i++) {
        ctx.fillStyle = 'red';
        ctx.fillRect((Object.values(players)[i].x-1) * WUNIT, (REGION_HEIGHT - Object.values(players)[i].y - 1) * HUNIT, WUNIT / 2, HUNIT);
      }
    };
    function drawhotbar(newhotbar) {
      ctx2.fillStyle = '#b8c8d2';
      ctx2.fillRect(0, 0, $hotbar.width, $hotbar.height);
      hotbar = newhotbar;
      for (let i = 0; i < 10; i++) {
        if (Carryable[hotbar[i]] === 'Copper') {
          ctx2.fillStyle = '#dfba85';
        } else
        if (Carryable[hotbar[i]] === 'Tin') {
          ctx2.fillStyle = '#dcdfd6';
        } else
        if (Carryable[hotbar[i]] === 'Stone') {
          ctx2.fillStyle = 'darkgrey';
        } else
        if (Carryable[hotbar[i]] === 'CherryLog') {
          ctx2.fillStyle = '#87331e';
        } else
        if (Carryable[hotbar[i]] === 'StoneTool') {
            ctx.fillStyle = '#faf';
        } else {
          ctx2.fillStyle = '#b8c8d2';
        }
        ctx2.fillRect(5, 5+(i*35), 30, 30);
      }
    }
    function start() {
      let socket = new WebSocket(HOST);
      socket.onopen = () => {socket.send('getworld')};
      socket.onclose = () => setTimeout(start, 5);
      document.body.addEventListener('keydown', e=>{
          if (e.code === "KeyD") {
            socket.send('right');
          }
          if (e.code === "KeyA") {
            socket.send('left');
          }
          if (e.code === "KeyL") {
            socket.send('use');
          }
      });
      socket.onmessage = function (event) {
        // console.log(event.data)
        let msg = JSON.parse(event.data);
        if (msg.type === 'confirm') {
          drawfullmap(msg.map, msg.selected);
          drawhotbar(msg.hotbar)
        }
        if (msg.type === 'pingjoined') {
          if (joinedmessage) {
            joinedmessage = false;
            name = msg.name;
          }
          // console.log(msg.name+' joined.');
        }
        if (msg.type === 'pingpos') {
          players = msg.players;
        }
      }
    }
    bigrocktinsheet.onload = start;
</script>
</body>
</html>