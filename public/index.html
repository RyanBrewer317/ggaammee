<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ggaammee</title>
</head>
<body>
<table>
    <tr>
        <td>
            <canvas id="screen" style="display: inline; margin-right: 0; padding-right: 0;"></canvas>
        </td>
        <td>
            <canvas id="hotbar" style="margin-left: 0; padding-left: 0; display: inline;"></canvas>
        </td>
    </tr>
</table>

<script>
    const HOST = location.origin.replace(/^http/, 'ws');
    const Carryable = ['copper', 'tin', 'stone', 'cherrylog'];
    let hotbar = ['', '', '', '', '', '', '', '', '', ''];
    let $screen = document.getElementById('screen');
    let $hotbar = document.getElementById('hotbar');
    $screen.width = Math.floor(innerWidth-100);
    $screen.height = Math.floor(innerHeight-100);
    $hotbar.height = 355;
    $hotbar.width = 50;
    let REGION_HEIGHT = 64;
    let REGION_WIDTH = 127;
    let WUNIT = Math.round($screen.width/REGION_WIDTH)*3;
    let HUNIT = Math.round($screen.height/REGION_HEIGHT)*3;
    let ctx = $screen.getContext('2d');
    let ctx2 = $hotbar.getContext('2d');
    let joinedmessage = true;
    let name = '';
    let players = {};
    let drawfullmap = (map, selected, newhotbar) => {
      console.log('drawing map');
      let textmap = map;
      let selected_block = selected;
      let hero = {};
      for (p in players) {
        if (p === name && players.hasOwnProperty(p)) {
          hero = players[p];
        }
      }
      let transposed = [];
      for (let y = 0; y < REGION_HEIGHT; y++) {
        transposed.push(textmap.split('<br>')[y].split(''));
      }
      let RegionalMap = transposed[0].map((_, colIndex) => transposed.map(row => row[colIndex]));
      // noinspection SillyAssignmentJS
      $screen.width = $screen.width;
      ctx.translate(Math.round(-hero.x*WUNIT+(REGION_WIDTH*WUNIT/6)), Math.round(-(REGION_HEIGHT-hero.y-1)*HUNIT+(REGION_HEIGHT*HUNIT/6)));
      for (let y = 0; y < REGION_HEIGHT; y++) {
        for (let x = 0; x < REGION_WIDTH; x++) {
          let block = RegionalMap[x][y];
          if (block === 'D') {
            ctx.fillStyle = '#593c06'
          } else if (block === 'B') {
            ctx.fillStyle = 'black';
          } else if (block === ' ') {
            ctx.fillStyle = '#dbffff'
          } else if (['S', 'T', 'C'].includes(block)) {
            ctx.fillStyle = 'darkgrey';
          } else if (block === 'L') {
            ctx.fillStyle = '#009414';
          } else if (block === 'H') {
            ctx.fillStyle = '#87331e';
          }

          ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT);

          if (block === 'D' && RegionalMap[x][y-1] && RegionalMap[x][y-1] === ' ') {
            ctx.fillStyle = '#208e24';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT, HUNIT/3);
          }
          if (block === 'H' && RegionalMap[x+1] && RegionalMap[x+1][y] === ' ') {
            ctx.fillStyle = '#dbffff';
            ctx.fillRect((x+0.75)*WUNIT, y*HUNIT, WUNIT/4, HUNIT);
          }
          if (block === 'H' && RegionalMap[x-1] && RegionalMap[x-1][y] === ' ') {
            ctx.fillStyle = '#dbffff';
            ctx.fillRect(x*WUNIT, y*HUNIT, WUNIT/4, HUNIT);
          }
          if (block === 'T') ctx.fillStyle = '#dcdfd6';
          if (block === 'C') ctx.fillStyle = '#dfba85';
          if (block === 'T' || block === 'C') {
            ctx.fillRect((x+0.6)*WUNIT, (y+0.2)*HUNIT, WUNIT/6, HUNIT/6);
            ctx.fillRect((x+0.3)*WUNIT, (y+0.7)*HUNIT, WUNIT/8, HUNIT/8);
          }
        }
      }
      if (RegionalMap[selected_block[0]][(REGION_HEIGHT - selected_block[1] - 1)] !== ' ') {
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 0.5;
        ctx.strokeRect(selected_block[0] * WUNIT, (REGION_HEIGHT - selected_block[1] - 1) * HUNIT, WUNIT, HUNIT);
      }
      for (let i = 0; i < Object.values(players).length; i++) {
        ctx.fillStyle = 'red';
        ctx.fillRect(Object.values(players)[i].x * WUNIT, (REGION_HEIGHT - Object.values(players)[i].y - 1) * HUNIT, WUNIT / 2, HUNIT);
      }
      ctx2.fillStyle = '#b8c8d2';
      ctx2.fillRect(0, 0, $hotbar.width, $hotbar.height);
      hotbar = newhotbar;
      for (let i = 0; i < 10; i++) {
        if (Carryable[hotbar[i]] === 'copper') {
          ctx2.fillStyle = '#dfba85';
        } else
        if (Carryable[hotbar[i]] === 'tin') {
          ctx2.fillStyle = '#dcdfd6';
        } else
        if (Carryable[hotbar[i]] === 'stone') {
          ctx2.fillStyle = 'darkgrey';
        } else
        if (Carryable[hotbar[i]] === 'cherrylog') {
          ctx2.fillStyle = '#87331e';
        } else {
          ctx2.fillStyle = '#b8c8d2';
        }
        ctx2.fillRect(5, 5+(i*35), 30, 30);
      }
    };
    function start() {
      let socket = new WebSocket(HOST);
      socket.onopen = () => {socket.send('getworld')};
      socket.onclose = start;
      document.body.addEventListener('keydown', e=>{
          if (e.code === "KeyD") {
            socket.send('right');
          }
          if (e.code === "KeyA") {
            socket.send('left');
          }
          if (e.code === "KeyL") {
            socket.send('use');
          }
      });
      socket.onmessage = function (event) {
        let msg = JSON.parse(event.data);
        if (msg.type === 'confirm') {
          drawfullmap(msg.map, msg.selected, msg.hotbar);
        }
        if (msg.type === 'pingjoined') {
          if (joinedmessage) {
            joinedmessage = false;
            name = msg.name;
          }
          console.log(msg.name+' joined.');
        }
        if (msg.type === 'pingpos') {
          players = msg.players;
        }
      }
    }
    start();
</script>
</body>
</html>